<div id="mypage">
  <div class="container py-5 pt-5 mt-5 mypage-container">

    <!-- å¹´æœˆåº¦ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ -->
    <div class="sticky-top bg-white z-index-sticky month-selector-wrapper">
      <%= render 'shared/month_selector' %>
    </div>

    <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚«ãƒ¼ãƒ‰ï¼ˆå›ºå®šï¼‰ -->
    <div class="sticky-top bg-white z-index-sticky user-info-wrapper">
      <div class="card shadow mb-4">
        <div class="card-body" style="background-color: #dee2e6;">
          <!-- ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—è¡¨ç¤º -->
          <div class="d-none d-md-flex justify-content-between align-items-start">
            <div>
              <h3 class="card-title"><%= @user.name %></h3>
              <p class="mb-1"><strong>ğŸ“§ ãƒ¡ãƒ¼ãƒ«:</strong> <span class="text-break"><%= @user.email %></span></p>
              <p class="mb-1"><strong>ğŸ¤ ãƒ¬ãƒ™ãƒ«:</strong> <%= @user.level_label %></p>
              <p class="mb-0"><strong>ğŸ†” Lã‚¹ãƒ†ãƒƒãƒ—ID:</strong> <code class="text-purple"><%= @user.lstep_user_id.presence || "æœªç™»éŒ²" %></code></p>
            </div>
            <div class="text-end">
              <p>æœ¬äººå£²ä¸Šï¼š<%= number_with_delimiter(@user.own_monthly_sales_total(@selected_month)) %>å††</p>
              <p>ä¸‹ä½å£²ä¸Šï¼š<%= number_with_delimiter(@user.total_sales_with_descendants(@selected_month) - @user.own_monthly_sales_total(@selected_month)) %>å††</p>
              <p>åˆè¨ˆå£²ä¸Šï¼š<strong><%= number_with_delimiter(@user.total_sales_with_descendants(@selected_month).to_i) %></strong> å††</p>
              <div class="mt-2">
                <%= link_to "å£²ä¸Šæ˜ç´°", sales_path(user_id: @user.id, month: @selected_month), class: "btn btn-outline-primary btn-sm" %>
              </div>
            </div>
          </div>

          <!-- ãƒ¢ãƒã‚¤ãƒ«è¡¨ç¤º -->
          <div class="d-md-none">
            <h3 class="card-title text-center mb-3"><%= @user.name %></h3>
            
            <div class="mb-3">
              <p class="mb-1"><strong>ğŸ“§ ãƒ¡ãƒ¼ãƒ«:</strong> <span class="text-break"><%= @user.email %></span></p>
              <p class="mb-1"><strong>ğŸ¤ ãƒ¬ãƒ™ãƒ«:</strong> <%= @user.level_label %></p>
              <p class="mb-0"><strong>ğŸ†” Lã‚¹ãƒ†ãƒƒãƒ—ID:</strong> <code class="text-purple"><%= @user.lstep_user_id.presence || "æœªç™»éŒ²" %></code></p>
            </div>
            
            <div class="text-center">
              <p class="mb-1">æœ¬äººå£²ä¸Šï¼š<%= number_with_delimiter(@user.own_monthly_sales_total(@selected_month)) %>å††</p>
              <p class="mb-1">ä¸‹ä½å£²ä¸Šï¼š<%= number_with_delimiter(@user.total_sales_with_descendants(@selected_month) - @user.own_monthly_sales_total(@selected_month)) %>å††</p>
              <p class="mb-2">åˆè¨ˆå£²ä¸Šï¼š<strong><%= number_with_delimiter(@user.total_sales_with_descendants(@selected_month).to_i) %></strong> å††</p>
              <div>
                <%= link_to "å£²ä¸Šæ˜ç´°", sales_path(user_id: @user.id, month: @selected_month), class: "btn btn-outline-primary btn-sm" %>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ä¸‹ä½ç´¹ä»‹è€…ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="card shadow mt-3">
      <div class="card-header bg-light">
        <h5 class="mb-0">ğŸ‘‡ ä¸‹ä½ç´¹ä»‹è€…</h5>
      </div>
      <div class="card-body">
        <% if @user.referrals.any? %>
          <% @user.referrals.each_with_index do |ref_user, i| %>
            <div class="card mb-3 hover-pointer" onclick="window.location.href='<%= user_path(ref_user) %>'">
              <div class="card-body">
                <!-- ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—è¡¨ç¤º -->
                <div class="d-none d-md-block">
                  <div class="row align-items-start">
                    <div class="col-md-8">
                      <p class="mb-1 fw-bold text-success">#<%= i + 1 %>. <%= ref_user.name %>ï¼ˆ<%= ref_user.level_label %>ï¼‰</p>
                      <p class="mb-1 text-break">ğŸ“§ <%= ref_user.email %></p>
                      <p class="mb-1">ğŸ†” <code class="text-purple"><%= ref_user.lstep_user_id.presence || "æœªç™»éŒ²" %></code></p>
                      <div>å£²ä¸Šï¼š<%= number_with_delimiter(ref_user.total_sales_with_descendants(@selected_month).to_i) %>å††</div>
                      <div>ã‚¤ãƒ³ã‚»ãƒ³ãƒ†ã‚£ãƒ–ï¼ˆ<%= @selected_month %>ï¼‰ï¼š<strong class="text-success"><%= number_with_delimiter(ref_user.bonus_in_month(@selected_month).to_i) %></strong> å††</div>
                    </div>
                    <div class="col-md-4 text-end">
                      <%= link_to "å£²ä¸Šæ˜ç´°", sales_path(user_id: ref_user.id), class: "btn btn-outline-primary btn-sm", onclick: "event.stopPropagation();" %>
                    </div>
                  </div>
                </div>

                <!-- ãƒ¢ãƒã‚¤ãƒ«è¡¨ç¤º -->
                <div class="d-md-none">
                  <div class="text-center mb-2">
                    <p class="mb-1 fw-bold text-success">#<%= i + 1 %>. <%= ref_user.name %>ï¼ˆ<%= ref_user.level_label %>ï¼‰</p>
                  </div>
                  
                  <div class="mb-2">
                    <p class="mb-1 small text-break">ğŸ“§ <%= ref_user.email %></p>
                    <p class="mb-1 small">ğŸ†” <code class="text-purple"><%= ref_user.lstep_user_id.presence || "æœªç™»éŒ²" %></code></p>
                  </div>
                  
                  <div class="text-center mb-2">
                    <div class="small">å£²ä¸Šï¼š<%= number_with_delimiter(ref_user.total_sales_with_descendants(@selected_month).to_i) %>å††</div>
                    <div class="small mb-2">ã‚¤ãƒ³ã‚»ãƒ³ãƒ†ã‚£ãƒ–ï¼ˆ<%= @selected_month %>ï¼‰ï¼š<strong class="text-success"><%= number_with_delimiter(ref_user.bonus_in_month(@selected_month).to_i) %></strong> å††</div>
                    <%= link_to "å£²ä¸Šæ˜ç´°", sales_path(user_id: ref_user.id), class: "btn btn-outline-primary btn-sm", onclick: "event.stopPropagation();" %>
                  </div>
                </div>
              </div>
            </div>
          <% end %>
        <% else %>
          <p class="text-muted mb-0">ä¸‹ä½ç´¹ä»‹è€…ãªã—</p>
        <% end %>
      </div>
    </div>

  </div>
</div>

<style>
  .mypage-container {
    margin-top: 80px !important;
  }
  
  /* navbarã‚’å¸¸ã«æœ€å‰é¢ã«è¡¨ç¤º */
  .navbar {
    z-index: 99999 !important;
    position: fixed !important;
    top: 0 !important;
    width: 100% !important;
  }
  
  /* stickyè¦ç´ ã®z-indexã‚’èª¿æ•´ */
  .month-selector-wrapper {
    z-index: 1020 !important;
  }
  
  .user-info-wrapper {
    z-index: 1010 !important;
  }
  
  /* ä¸‹ä½ç´¹ä»‹è€…ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹æ”¹è¡Œå¯¾å¿œ */
  .text-break {
    word-wrap: break-word !important;
    word-break: break-all !important;
    overflow-wrap: break-word !important;
    white-space: normal !important;
    max-width: 100% !important;
  }
  
  /* ä¸‹ä½ç´¹ä»‹è€…ã‚«ãƒ¼ãƒ‰å†…ã®ãƒ†ã‚­ã‚¹ãƒˆèª¿æ•´ */
  .card-body .mb-2 p {
    word-wrap: break-word;
    word-break: break-all;
    overflow-wrap: break-word;
  }
  
  /* ã‚¹ãƒãƒ›ã§ã®èª¿æ•´ */
  @media (max-width: 768px) {
    .mypage-container {
      margin-top: 100px !important;
    }
    
    .month-selector-wrapper {
      top: 70px !important;
    }
    
    .user-info-wrapper {
      top: 130px !important;
    }
    
    /* ã‚¹ãƒãƒ›ã§ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹è¡¨ç¤ºèª¿æ•´ */
    .text-break {
      font-size: 12px !important;
      line-height: 1.3 !important;
    }
  }
</style>