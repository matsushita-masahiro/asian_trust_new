<div id="purchases-index">
  <div class="container mt-5 pt-5">
  
    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
    <div class="sticky-top bg-white z-index-sticky month-selector-wrapper">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex gap-2">
          <%= link_to "ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°ã«æˆ»ã‚‹", user_path(@user, month: @selected_month), 
              class: "btn btn-outline-secondary btn-sm" %>
          
          <!-- è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ -->
          <% unless @user.level.value == 6 %>
            <% if @is_own_purchases %>
              <%= link_to "è²©å£²å±¥æ­´ã‚’è¦‹ã‚‹", purchases_user_path(@user, month: @selected_month), 
                  class: "btn btn-outline-primary btn-sm" %>
            <% else %>
              <%= link_to "è³¼å…¥å±¥æ­´ã‚’è¦‹ã‚‹", purchases_user_path(@user, month: @selected_month, view: 'own_purchases'), 
                  class: "btn btn-outline-info btn-sm" %>
            <% end %>
          <% end %>
        </div>
        
        <div>
          <%= form_with url: purchases_user_path(@user), method: :get, local: true do %>
            <%= hidden_field_tag :view, params[:view] if params[:view] %>
            <%= select_tag :month, options_for_select(@month_options, @selected_month),
                class: "form-select d-inline-block w-auto", onchange: "this.form.submit();" %>
          <% end %>
        </div>
      </div>
    </div>
  
    <!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º -->
    <% if flash[:alert] %>
      <div class="alert alert-warning alert-dismissible fade show" role="alert">
        <%= flash[:alert] %>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    <% end %>

    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="bg-light p-3 rounded shadow-sm mb-4">
      <h4 class="mb-2 fw-bold text-dark">
        <%= @user.name %>ã®<%= @is_own_purchases ? 'è³¼å…¥å±¥æ­´' : (@is_customer_view ? 'è³¼å…¥å±¥æ­´' : 'è²©å£²å±¥æ­´') %>
      </h4>
      <div class="text-muted fs-6">
        ğŸ“… ï¼ˆ<%= @selected_month_name %>ï¼‰<%= @is_own_purchases ? 'è³¼å…¥å®Ÿç¸¾' : (@is_customer_view ? 'è³¼å…¥å®Ÿç¸¾' : 'è²©å£²å®Ÿç¸¾') %>
      </div>
    </div>
  
    <% if @purchases.any? %>
      <div class="table-responsive">
        <table class="table table-bordered table-hover align-middle text-nowrap">
          <thead class="table-secondary text-white">
            <tr>
              <% if @is_customer_view %>
                <th>å•†å“å</th>
                <th class="text-end">å˜ä¾¡ï¼ˆå††ï¼‰</th>
                <th class="text-end">æ•°é‡</th>
                <th class="text-end">åˆè¨ˆï¼ˆå††ï¼‰</th>
                <th>ä»²ä»‹è€…</th>
                <th>è³¼å…¥æ—¥æ™‚</th>
              <% else %>
                <th>è³¼å…¥è€…å</th>
                <th>å•†å“å</th>
                <th class="text-end">å˜ä¾¡ï¼ˆå††ï¼‰</th>
                <th class="text-end">æ•°é‡</th>
                <th class="text-end">åˆè¨ˆï¼ˆå††ï¼‰</th>
                <th class="text-end">è³¼å…¥å˜ä¾¡ï¼ˆå††ï¼‰</th>
                <th class="text-end">ã‚¤ãƒ³ã‚»ãƒ³ãƒ†ã‚£ãƒ–ï¼ˆå††ï¼‰</th>
                <th>ãƒ¡ãƒ¼ãƒ«</th>
                <th>é›»è©±ç•ªå·</th>
                <th>ä½æ‰€</th>
                <th>è³¼å…¥æ—¥æ™‚</th>
              <% end %>
            </tr>
          </thead>
          <tbody>
            <% total_sum = 0 %>
            <% total_bonus = 0 %>
  
            <% @purchases.each do |purchase| %>
              <% total = purchase.total_price %>
              <% unless @is_customer_view %>
                <% bonus = @user.bonus_for_purchase(purchase) %>
                <% total_bonus += bonus %>
              <% end %>
              <% total_sum += total %>
              
              <% purchase.purchase_items.each_with_index do |item, index| %>
                <% unless @is_customer_view %>
                  <% 
                    # å„ã‚¢ã‚¤ãƒ†ãƒ ã«å¯¾ã™ã‚‹ãƒœãƒ¼ãƒŠã‚¹ã‚’å€‹åˆ¥è¨ˆç®—
                    temp_purchase = Purchase.new(user: purchase.user, buyer: purchase.buyer, purchased_at: purchase.purchased_at)
                    temp_item = PurchaseItem.new(purchase: temp_purchase, product: item.product, quantity: item.quantity, unit_price: item.unit_price, seller_price: item.seller_price)
                    temp_purchase.purchase_items = [temp_item]
                    item_bonus = @user.bonus_for_purchase(temp_purchase)
                  %>
                <% end %>
                
                <tr>
                  <% if @is_customer_view %>
                    <!-- ãŠå®¢æ§˜ã®è³¼å…¥å±¥æ­´è¡¨ç¤º -->
                    <td><%= item.product.name %></td>
                    <td class="text-end"><%= number_with_delimiter(item.unit_price) %></td>
                    <td class="text-end"><%= item.quantity %></td>
                    <td class="text-end text-danger fw-bold"><%= number_with_delimiter(item.total_price) %></td>
                    <% if index == 0 %>
                      <td rowspan="<%= purchase.purchase_items.count %>">-</td>
                      <td rowspan="<%= purchase.purchase_items.count %>"><%= purchase.purchased_at&.strftime("%Y/%m/%d %H:%M") %></td>
                    <% end %>
                  <% else %>
                    <!-- è²©å£²å±¥æ­´è¡¨ç¤º -->
                    <% if index == 0 %>
                      <td rowspan="<%= purchase.purchase_items.count %>"><%= purchase.buyer&.name || "-" %></td>
                    <% end %>
                    <td><%= item.product.name %></td>
                    <td class="text-end"><%= number_with_delimiter(item.unit_price) %></td>
                    <td class="text-end"><%= item.quantity %></td>
                    <td class="text-end text-danger fw-bold"><%= number_with_delimiter(item.total_price) %></td>
                    <td class="text-end text-info fw-bold"><%= number_with_delimiter(item.seller_price) %></td>
                    <td class="text-end text-success fw-bold"><%= number_with_delimiter(item_bonus) %></td>
                    <% if index == 0 %>
                      <td rowspan="<%= purchase.purchase_items.count %>"><%= purchase.buyer&.email || "-" %></td>
                      <td rowspan="<%= purchase.purchase_items.count %>">-</td>
                      <td rowspan="<%= purchase.purchase_items.count %>">-</td>
                      <td rowspan="<%= purchase.purchase_items.count %>"><%= purchase.purchased_at&.strftime("%Y/%m/%d %H:%M") %></td>
                    <% end %>
                  <% end %>
                </tr>
              <% end %>
            <% end %>
  
            <!-- åˆè¨ˆè¡Œ -->
            <tr class="table-primary fw-bold text-end">
              <% if @is_customer_view %>
                <td colspan="3" class="text-end">åˆè¨ˆ</td>
                <td class="text-end text-danger"><%= number_with_delimiter(total_sum) %></td>
                <td colspan="2"></td>
              <% else %>
                <td colspan="4" class="text-end">åˆè¨ˆ</td>
                <td class="text-end text-danger"><%= number_with_delimiter(total_sum) %></td>
                <td class="text-end"></td> <!-- è²©å£²åº—è³¼å…¥å˜ä¾¡åˆ—ï¼ˆç©ºï¼‰ -->
                <td class="text-end text-success"><%= number_with_delimiter(total_bonus) %></td>
                <td colspan="4"></td> <!-- ãƒ¡ãƒ¼ãƒ«ã€é›»è©±ã€ä½æ‰€ã€è³¼å…¥æ—¥æ™‚åˆ—ï¼ˆç©ºï¼‰ -->
              <% end %>
            </tr>
          </tbody>
        </table>
      </div>
    <% else %>
      <div class="text-center py-5">
        <div class="mb-3">
          <i class="fas fa-inbox fa-3x text-muted"></i>
        </div>
        <h5 class="text-muted">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</h5>
        <p class="text-muted">
          <%= @selected_month_name %>ã®<%= @is_own_purchases ? 'è³¼å…¥å±¥æ­´' : (@is_customer_view ? 'è³¼å…¥å±¥æ­´' : 'è²©å£²å±¥æ­´') %>ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
        </p>
        <% unless @is_own_purchases || @is_customer_view %>
          <p class="text-muted small">
            ä»–ã®æœˆã‚’é¸æŠã™ã‚‹ã‹ã€<%= link_to "è³¼å…¥å±¥æ­´", purchases_user_path(@user, month: @selected_month, view: 'own_purchases'), class: "text-decoration-none" %>ã‚’ã”ç¢ºèªãã ã•ã„ã€‚
          </p>
        <% end %>
      </div>
    <% end %>
  

  </div>

</div>

<style>
  .z-index-sticky {
    z-index: 1030;
  }
  
  .month-selector-wrapper {
    padding: 1rem 0;
    border-bottom: 1px solid #dee2e6;
    margin-bottom: 1rem;
  }
  
  .table th {
    font-weight: 600;
    font-size: 0.9rem;
  }
  
  .table td {
    font-size: 0.9rem;
  }
  
  .table-hover tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.05);
  }
  
  /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
  @media (max-width: 768px) {
    .d-flex.justify-content-between {
      flex-direction: column;
      align-items: flex-start !important;
    }
    
    .d-flex.justify-content-between > div:first-child {
      margin-bottom: 0.5rem;
    }
    
    .d-flex.gap-2 {
      flex-direction: column;
      width: 100%;
    }
    
    .d-flex.gap-2 .btn {
      width: 100%;
      margin-bottom: 0.25rem;
    }
    
    .table-responsive {
      font-size: 0.8rem;
    }
    
    .container {
      padding-left: 0.5rem;
      padding-right: 0.5rem;
    }
    
    .month-selector-wrapper {
      padding: 0.5rem 0;
    }
  }
</style>