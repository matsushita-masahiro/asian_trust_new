# 実装計画

- [x] 1. データベーススキーマの準備
  - `purchases` テーブルに `buyer_id` カラムを追加するマイグレーションを作成
  - 適切なインデックスと外部キー制約を設定
  - _要件: 1.1, 1.2, 1.3_

- [x] 2. データ移行処理の実装
  - 既存の `customers` データを `users` テーブルに移行するマイグレーションを作成
  - `purchases.customer_id` を `purchases.buyer_id` に変換する処理を実装
  - データ整合性チェック機能を追加
  - _要件: 3.1, 3.2, 3.3_

- [x] 3. Purchase モデルの更新
  - `buyer` リレーションを追加（`belongs_to :buyer, class_name: 'User'`）
  - `bought_by` スコープを実装（特定ユーザーの購入履歴）
  - `sold_by` スコープを実装（特定ユーザーの販売履歴、自分の購入は除外）
  - 既存の `customer` リレーションを削除
  - _要件: 1.1, 2.1, 2.2_

- [x] 4. User モデルの更新
  - `purchases` リレーションを追加（`has_many :purchases, foreign_key: 'buyer_id'`）
  - `mediated_purchases` リレーションを追加（`has_many :mediated_purchases, class_name: 'Purchase', foreign_key: 'user_id'`）
  - `own_purchase_total` メソッドを実装（自分の購入合計）
  - `sales_total` メソッドを実装（販売合計、自分の購入は除外）
  - _要件: 1.1, 2.1, 2.2_

- [x] 5. UsersController の更新
  - `purchases` アクションのロジックを更新
  - `view=own_purchases` パラメータ処理を改善
  - 購入履歴と販売履歴の適切な分離を実装
  - エラーハンドリングを追加
  - _要件: 2.1, 2.2, 2.3_

- [x] 6. 購入履歴ビューの更新
  - 購入履歴表示時のタイトルとラベルを更新
  - 購入者情報の表示ロジックを修正
  - 販売履歴との表示の違いを明確化
  - _要件: 4.1, 4.2, 4.3, 4.4_

- [x] 7. Customer モデルとテーブルの削除
  - Customer モデルファイルを削除
  - `purchases.customer_id` カラムを削除するマイグレーションを作成
  - `customers` テーブルを削除するマイグレーションを作成
  - 関連するルートやコントローラーを削除
  - _要件: 3.1, 3.2, 3.3_

- [x] 8. テストデータの更新
  - 新しいデータ構造に合わせてシードデータを更新
  - 特約代理店1の購入データを適切に設定
  - 他のテストユーザーの購入・販売データを整備
  - _要件: 2.1, 2.2, 2.3_

- [x] 9. 統合テストの実行
  - 購入履歴表示の動作確認
  - 販売履歴表示の動作確認
  - データ移行の完全性確認
  - パフォーマンステストの実行
  - _要件: 2.1, 2.2, 2.3, 5.1, 5.2, 5.3_

- [x] 10. UI の最終調整
  - 購入履歴と販売履歴のナビゲーション改善
  - エラーメッセージの適切な表示
  - レスポンシブデザインの確認
  - _要件: 4.1, 4.2, 4.3, 4.4_