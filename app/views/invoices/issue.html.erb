<div class="container py-5 pt-5 mt-5">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="text-primary">ğŸ“‹ è«‹æ±‚æ›¸ç™ºè¡Œ</h4>
        <div class="d-flex align-items-center">
          <div class="me-3">
            <%= form_with url: issue_invoices_path, method: :get, local: true, class: "d-flex align-items-center" do |f| %>
              <small class="text-muted me-3">è«‹æ±‚å…ƒ: <%= current_user.name.presence || current_user.email %></small>
              <label class="form-label me-2 mb-0">å¯¾è±¡æœˆ:</label>
              <%= f.month_field :month, value: @selected_month, class: "form-control me-2", style: "width: 180px;", onchange: "this.form.submit();" %>
            <% end %>
          </div>
          <div>
            <%= link_to "å±¥æ­´ã‚’è¦‹ã‚‹", history_invoices_path, class: "btn btn-outline-info me-2" %>
            <%= link_to "è«‹æ±‚æ›¸ç®¡ç†ã«æˆ»ã‚‹", invoices_path, class: "btn btn-outline-secondary" %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card shadow">
        <div class="card-header bg-light">
          <h5 class="mb-0">æ–°ã—ã„è«‹æ±‚æ›¸ã‚’ä½œæˆ</h5>
        </div>
        <div class="card-body">
          <% if @invoice_recipients.any? %>
            <%= form_with model: @invoice, local: true, class: "needs-validation", novalidate: true do |f| %>
              <div class="mb-3">
                <%= f.label :invoice_recipient_id, "è«‹æ±‚å…ˆ", class: "form-label" %>
                <%= f.select :invoice_recipient_id, 
                    options_from_collection_for_select(@invoice_recipients, :id, :name), 
                    { prompt: 'è«‹æ±‚å…ˆã‚’é¸æŠã—ã¦ãã ã•ã„' }, 
                    { class: "form-select", required: true } %>
                <div class="invalid-feedback">
                  è«‹æ±‚å…ˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚
                </div>
              </div>

              <div class="mb-3">
                <%= f.label :invoice_date, "è«‹æ±‚æ›¸ç™ºè¡Œæ—¥", class: "form-label" %>
                <%= f.date_field :invoice_date, class: "form-control", value: Date.current.strftime("%Y-%m-%d"), required: true %>
                <div class="invalid-feedback">
                  è«‹æ±‚æ›¸ç™ºè¡Œæ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
                </div>
              </div>

              <div class="mb-3">
                <%= f.label :total_amount, "è«‹æ±‚é‡‘é¡ï¼ˆ#{@selected_month}ã®ã‚¤ãƒ³ã‚»ãƒ³ãƒ†ã‚£ãƒ–åˆè¨ˆï¼‰", class: "form-label" %>
                <div class="input-group">
                  <span class="input-group-text">Â¥</span>
                  <%= f.number_field :total_amount, class: "form-control bg-light", readonly: true %>
                </div>
                <div class="form-text">â€» é¸æŠã•ã‚ŒãŸæœˆã®ã‚¤ãƒ³ã‚»ãƒ³ãƒ†ã‚£ãƒ–åˆè¨ˆé¡ãŒè‡ªå‹•è¨ˆç®—ã•ã‚Œã¾ã™</div>
              </div>

              <div class="mb-3">
                <%= f.label :due_date, "æ”¯æ‰•æœŸé™", class: "form-label" %>
                <%= f.date_field :due_date, class: "form-control", value: 1.month.from_now.strftime("%Y-%m-%d") %>
              </div>

              <div class="mb-3">
                <%= f.label :notes, "å‚™è€ƒãƒ»è©³ç´°", class: "form-label" %>
                <%= f.text_area :notes, class: "form-control", rows: 4, placeholder: "è«‹æ±‚å†…å®¹ã®è©³ç´°ã‚„å‚™è€ƒã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" %>
              </div>

              <!-- éŠ€è¡Œæƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
              <h6 class="text-muted mb-3 mt-4">æŒ¯è¾¼å…ˆæƒ…å ±</h6>
              
              <div class="row">
                <div class="col-md-6 mb-3">
                  <%= f.label :bank_name, "éŠ€è¡Œå", class: "form-label" %>
                  <%= f.text_field :bank_name, class: "form-control", placeholder: "â—‹â—‹éŠ€è¡Œ" %>
                </div>
                <div class="col-md-6 mb-3">
                  <%= f.label :bank_branch_name, "æ”¯åº—å", class: "form-label" %>
                  <%= f.text_field :bank_branch_name, class: "form-control", placeholder: "â—‹â—‹æ”¯åº—" %>
                </div>
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <%= f.label :bank_account_type, "å£åº§ç¨®åˆ¥", class: "form-label" %>
                  <%= f.select :bank_account_type, 
                      options_for_select([
                        ['æ™®é€š', 'savings'],
                        ['å½“åº§', 'checking']
                      ]), 
                      { prompt: 'é¸æŠã—ã¦ãã ã•ã„' }, 
                      { class: "form-select" } %>
                </div>
                <div class="col-md-6 mb-3">
                  <%= f.label :bank_account_number, "å£åº§ç•ªå·", class: "form-label" %>
                  <%= f.text_field :bank_account_number, class: "form-control", placeholder: "1234567" %>
                </div>
              </div>

              <div class="mb-3">
                <%= f.label :bank_account_name, "å£åº§åç¾©", class: "form-label" %>
                <%= f.text_field :bank_account_name, class: "form-control", placeholder: "ã‚«ï¼‰ã‚µãƒ³ãƒ—ãƒ«" %>
              </div>

              <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <%= link_to "ã‚­ãƒ£ãƒ³ã‚»ãƒ«", invoices_path, class: "btn btn-outline-secondary me-md-2" %>
                <%= f.submit "è«‹æ±‚æ›¸ä½œæˆãƒ»ç¢ºèª", class: "btn btn-primary" %>
              </div>
            <% end %>
          <% else %>
            <div class="text-center py-4">
              <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
              <h5>è«‹æ±‚å…ˆãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</h5>
              <p class="text-muted">è«‹æ±‚æ›¸ã‚’ç™ºè¡Œã™ã‚‹ã«ã¯ã€ç®¡ç†è€…ã«è«‹æ±‚å…ˆæƒ…å ±ã®è¨­å®šã‚’ä¾é ¼ã—ã¦ãã ã•ã„ã€‚</p>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- ã‚¤ãƒ³ã‚»ãƒ³ãƒ†ã‚£ãƒ–å†…è¨³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
  <% if @bonus_details.any? %>
    <div class="row justify-content-center mt-4">
      <div class="col-md-10">
        <div class="card shadow">
          <div class="card-header bg-light">
            <h5 class="mb-0">ğŸ“Š <%= @selected_month %> ã‚¤ãƒ³ã‚»ãƒ³ãƒ†ã‚£ãƒ–å†…è¨³</h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead class="table-light">
                  <tr>
                    <th>ç¨®åˆ¥</th>
                    <th>å¯¾è±¡è€…</th>
                    <th>å•†å“å</th>
                    <th>æ•°é‡</th>
                    <th>å˜ä¾¡ã‚¤ãƒ³ã‚»ãƒ³ãƒ†ã‚£ãƒ–</th>
                    <th>åˆè¨ˆã‚¤ãƒ³ã‚»ãƒ³ãƒ†ã‚£ãƒ–</th>
                    <th>è³¼å…¥æ—¥</th>
                  </tr>
                </thead>
                <tbody>
                  <% @bonus_details.each do |detail| %>
                    <tr>
                      <td>
                        <% if detail[:type] == 'è‡ªå·±è²©å£²' %>
                          <span class="badge bg-primary">è‡ªå·±è²©å£²</span>
                        <% else %>
                          <span class="badge bg-success">ä¸‹ä½è²©å£²</span>
                        <% end %>
                      </td>
                      <td><%= detail[:user_name] %></td>
                      <td><%= detail[:product_name] %></td>
                      <td><%= detail[:quantity] %></td>
                      <td class="text-end">Â¥<%= number_with_delimiter(detail[:unit_bonus]) %></td>
                      <td class="text-end text-success fw-bold">Â¥<%= number_with_delimiter(detail[:total_bonus]) %></td>
                      <td><%= detail[:purchased_at].strftime("%Y/%m/%d") %></td>
                    </tr>
                  <% end %>
                </tbody>
                <tfoot class="table-light">
                  <tr>
                    <th colspan="5" class="text-end">åˆè¨ˆã‚¤ãƒ³ã‚»ãƒ³ãƒ†ã‚£ãƒ–:</th>
                    <th class="text-end text-primary fw-bold">Â¥<%= number_with_delimiter(@total_bonus) %></th>
                    <th></th>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% else %>
    <div class="row justify-content-center mt-4">
      <div class="col-md-8">
        <div class="card shadow">
          <div class="card-body text-center py-4">
            <i class="fas fa-info-circle fa-3x text-muted mb-3"></i>
            <h5>ã‚¤ãƒ³ã‚»ãƒ³ãƒ†ã‚£ãƒ–å†…è¨³ãªã—</h5>
            <p class="text-muted"><%= @selected_month %> ã«ã¯ã‚¤ãƒ³ã‚»ãƒ³ãƒ†ã‚£ãƒ–å¯¾è±¡ã®è²©å£²ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>
          </div>
        </div>
      </div>
    </div>
  <% end %>
</div>

<script>
// Bootstrap form validation
(function() {
  'use strict';
  window.addEventListener('load', function() {
    var forms = document.getElementsByClassName('needs-validation');
    var validation = Array.prototype.filter.call(forms, function(form) {
      form.addEventListener('submit', function(event) {
        if (form.checkValidity() === false) {
          event.preventDefault();
          event.stopPropagation();
        }
        form.classList.add('was-validated');
      }, false);
    });
  }, false);
})();
</script>