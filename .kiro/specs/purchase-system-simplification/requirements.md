# 購入システム簡素化 - 要件定義

## 概要

現在の購入システムでは `customers` テーブルと `users` テーブルが併存しており、データの整合性や管理が複雑になっています。この仕様では、購入データを `users` テーブルで一元化し、システムを簡素化します。

## 要件

### 要件1: データモデルの簡素化

**ユーザーストーリー:** システム管理者として、購入データの管理を簡素化したいので、`customers` テーブルを廃止し、`users` テーブルで一元管理したい

#### 受入基準
1. WHEN 購入が発生した場合 THEN `purchases` テーブルは以下の構造になる
   - `user_id`: 仲介者（代理店）のID
   - `buyer_id`: 購入者（ユーザー）のID
   - `purchased_at`: 購入日時
2. WHEN 自分自身が購入する場合 THEN `user_id` と `buyer_id` が同じ値になる
3. WHEN 他のユーザーが購入する場合 THEN `user_id`（仲介者）と `buyer_id`（購入者）が異なる値になる

### 要件2: 購入履歴の表示

**ユーザーストーリー:** 代理店として、自分の購入履歴と販売履歴を明確に区別して確認したいので、適切な画面で表示したい

#### 受入基準
1. WHEN 購入履歴を表示する場合 THEN `buyer_id` が自分のIDと一致する購入のみ表示される
2. WHEN 販売履歴を表示する場合 THEN `user_id` が自分のIDで、かつ `buyer_id` が自分以外の購入のみ表示される
3. WHEN 購入履歴画面にアクセスする場合 THEN 購入者情報、商品情報、金額が正しく表示される

### 要件3: 既存データの移行

**ユーザーストーリー:** システム管理者として、既存の `customers` テーブルのデータを失うことなく新しい構造に移行したいので、データ移行処理が必要

#### 受入基準
1. WHEN データ移行を実行する場合 THEN 既存の `purchases.customer_id` が適切な `purchases.buyer_id` に変換される
2. WHEN `customers` テーブルに `user_id` が設定されている場合 THEN そのまま `buyer_id` として使用される
3. WHEN `customers` テーブルに `user_id` が設定されていない場合 THEN 新しい `users` レコードを作成し、その ID を `buyer_id` として使用される

### 要件4: UI の更新

**ユーザーストーリー:** ユーザーとして、購入履歴と販売履歴を直感的に理解できる画面で確認したいので、適切なラベルと表示が必要

#### 受入基準
1. WHEN 購入履歴画面を表示する場合 THEN 「購入履歴」というタイトルが表示される
2. WHEN 販売履歴画面を表示する場合 THEN 「販売履歴」というタイトルが表示される
3. WHEN 購入履歴画面で購入者情報を表示する場合 THEN 自分の名前が表示される
4. WHEN 販売履歴画面で購入者情報を表示する場合 THEN 実際の購入者の名前が表示される

### 要件5: パフォーマンスの最適化

**ユーザーストーリー:** システム管理者として、データベースクエリのパフォーマンスを維持したいので、適切なインデックスとクエリ最適化が必要

#### 受入基準
1. WHEN 購入履歴を検索する場合 THEN `buyer_id` にインデックスが設定されている
2. WHEN 販売履歴を検索する場合 THEN `user_id` と `buyer_id` の複合インデックスが設定されている
3. WHEN 月別の購入データを検索する場合 THEN `purchased_at` にインデックスが設定されている