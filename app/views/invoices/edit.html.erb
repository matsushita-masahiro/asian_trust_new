<div class="container py-5 pt-5 mt-5">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-primary">📋 請求書編集</h2>
        <div>
          <%= link_to "確認画面に戻る", invoice_path(@invoice), class: "btn btn-outline-info me-2" %>
          <%= link_to "請求書管理に戻る", invoices_path, class: "btn btn-outline-secondary" %>
        </div>
      </div>
    </div>
  </div>

  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card shadow">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <h5 class="mb-0">請求書情報を編集</h5>
          <div class="d-flex align-items-center">
            <small class="text-muted me-3">請求元: <%= current_user.name.presence || current_user.email %></small>
            <small class="text-muted">対象月: <%= @selected_month %></small>
          </div>
        </div>
        <div class="card-body">
          <%= form_with model: @invoice, local: true, class: "needs-validation", novalidate: true do |f| %>
            <% if @invoice.errors.any? %>
              <div class="alert alert-danger">
                <h6>エラーが発生しました:</h6>
                <ul class="mb-0">
                  <% @invoice.errors.full_messages.each do |message| %>
                    <li><%= message %></li>
                  <% end %>
                </ul>
              </div>
            <% end %>

            <div class="mb-3">
              <%= f.label :invoice_recipient_id, "請求先", class: "form-label" %>
              <%= f.select :invoice_recipient_id, 
                  options_from_collection_for_select(@invoice_recipients, :id, :name, @invoice.invoice_recipient_id), 
                  { prompt: '請求先を選択してください' }, 
                  { class: "form-select", required: true } %>
              <div class="invalid-feedback">
                請求先を選択してください。
              </div>
            </div>

            <div class="mb-3">
              <%= f.label :invoice_date, "請求書発行日", class: "form-label" %>
              <%= f.date_field :invoice_date, class: "form-control", required: true %>
              <div class="invalid-feedback">
                請求書発行日を入力してください。
              </div>
            </div>

            <div class="mb-3">
              <%= f.label :total_amount, "請求金額", class: "form-label" %>
              <div class="input-group">
                <span class="input-group-text">¥</span>
                <%= f.number_field :total_amount, class: "form-control", required: true %>
              </div>
              <div class="invalid-feedback">
                請求金額を入力してください。
              </div>
            </div>

            <div class="mb-3">
              <%= f.label :due_date, "支払期限", class: "form-label" %>
              <%= f.date_field :due_date, class: "form-control" %>
            </div>

            <div class="mb-3">
              <%= f.label :notes, "備考・詳細", class: "form-label" %>
              <%= f.text_area :notes, class: "form-control", rows: 4, placeholder: "請求内容の詳細や備考を入力してください" %>
            </div>

            <!-- 銀行情報セクション -->
            <h6 class="text-muted mb-3 mt-4">振込先情報</h6>
            
            <div class="row">
              <div class="col-md-6 mb-3">
                <%= f.label :bank_name, "銀行名", class: "form-label" %>
                <%= f.text_field :bank_name, class: "form-control", placeholder: "○○銀行" %>
              </div>
              <div class="col-md-6 mb-3">
                <%= f.label :bank_branch_name, "支店名", class: "form-label" %>
                <%= f.text_field :bank_branch_name, class: "form-control", placeholder: "○○支店" %>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <%= f.label :bank_account_type, "口座種別", class: "form-label" %>
                <%= f.select :bank_account_type, 
                    options_for_select([
                      ['普通', 'savings'],
                      ['当座', 'checking']
                    ], @invoice.bank_account_type), 
                    { prompt: '選択してください' }, 
                    { class: "form-select" } %>
              </div>
              <div class="col-md-6 mb-3">
                <%= f.label :bank_account_number, "口座番号", class: "form-label" %>
                <%= f.text_field :bank_account_number, class: "form-control", placeholder: "1234567" %>
              </div>
            </div>

            <div class="mb-3">
              <%= f.label :bank_account_name, "口座名義", class: "form-label" %>
              <%= f.text_field :bank_account_name, class: "form-control", placeholder: "カ）サンプル" %>
            </div>

            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
              <%= link_to "キャンセル", invoice_path(@invoice), class: "btn btn-outline-secondary me-md-2" %>
              <%= f.submit "更新", class: "btn btn-primary" %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- インセンティブ内訳セクション -->
  <% if @bonus_details.any? %>
    <div class="row justify-content-center mt-4">
      <div class="col-md-10">
        <div class="card shadow">
          <div class="card-header bg-light">
            <h5 class="mb-0">📊 <%= @selected_month %> インセンティブ内訳</h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead class="table-light">
                  <tr>
                    <th>種別</th>
                    <th>対象者</th>
                    <th>商品名</th>
                    <th>数量</th>
                    <th>単価インセンティブ</th>
                    <th>合計インセンティブ</th>
                    <th>購入日</th>
                  </tr>
                </thead>
                <tbody>
                  <% @bonus_details.each do |detail| %>
                    <tr>
                      <td>
                        <% if detail[:type] == '自己販売' %>
                          <span class="badge bg-primary">自己販売</span>
                        <% else %>
                          <span class="badge bg-success">下位販売</span>
                        <% end %>
                      </td>
                      <td><%= detail[:user_name] %></td>
                      <td><%= detail[:product_name] %></td>
                      <td><%= detail[:quantity] %></td>
                      <td class="text-end">¥<%= number_with_delimiter(detail[:unit_bonus]) %></td>
                      <td class="text-end text-success fw-bold">¥<%= number_with_delimiter(detail[:total_bonus]) %></td>
                      <td><%= detail[:purchased_at].strftime("%Y/%m/%d") %></td>
                    </tr>
                  <% end %>
                </tbody>
                <tfoot class="table-light">
                  <tr>
                    <th colspan="5" class="text-end">合計インセンティブ:</th>
                    <th class="text-end text-primary fw-bold">¥<%= number_with_delimiter(@total_bonus) %></th>
                    <th></th>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% else %>
    <div class="row justify-content-center mt-4">
      <div class="col-md-8">
        <div class="card shadow">
          <div class="card-body text-center py-4">
            <i class="fas fa-info-circle fa-3x text-muted mb-3"></i>
            <h5>インセンティブ内訳なし</h5>
            <p class="text-muted"><%= @selected_month %> にはインセンティブ対象の販売がありませんでした。</p>
          </div>
        </div>
      </div>
    </div>
  <% end %>
</div>

<script>
// Bootstrap form validation
(function() {
  'use strict';
  window.addEventListener('load', function() {
    var forms = document.getElementsByClassName('needs-validation');
    var validation = Array.prototype.filter.call(forms, function(form) {
      form.addEventListener('submit', function(event) {
        if (form.checkValidity() === false) {
          event.preventDefault();
          event.stopPropagation();
        }
        form.classList.add('was-validated');
      }, false);
    });
  }, false);
})();
</script>