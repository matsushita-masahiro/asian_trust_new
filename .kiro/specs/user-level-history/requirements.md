# ユーザーレベル履歴管理機能 要件定義

## 概要

ユーザーのレベル変更履歴を管理し、購入時点でのレベルに基づいて正確なインセンティブ計算を行う機能を実装する。

## 要件

### 要件1: レベル履歴の記録

**ユーザーストーリー:** 管理者として、ユーザーのレベル変更履歴を記録したい。そうすることで、過去の購入に対するインセンティブを正確に計算できる。

#### 受入基準

1. WHEN ユーザーのレベルが変更される THEN システムは新しいレベル履歴レコードを作成する
2. WHEN レベル履歴レコードが作成される THEN 以下の情報が記録される：
   - ユーザーID
   - レベルID
   - 有効開始日時
   - 有効終了日時（次のレベル変更時に設定）
3. WHEN 初回ユーザー作成時 THEN 初期レベルの履歴レコードが自動作成される

### 要件2: 購入時点レベルの特定

**ユーザーストーリー:** システムとして、特定の購入日時におけるユーザーのレベルを特定したい。そうすることで、その時点での価格設定を使用できる。

#### 受入基準

1. WHEN 購入日時が指定される THEN システムはその時点で有効だったレベルを返す
2. WHEN 購入日時がレベル変更の境界日時と一致する THEN より新しいレベルを適用する
3. WHEN 該当する履歴が見つからない THEN 現在のレベルを返す

### 要件3: 履歴ベースインセンティブ計算

**ユーザーストーリー:** システムとして、購入時点でのレベルに基づいてインセンティブを計算したい。そうすることで、レベル変更後も過去の購入に対して正確なインセンティブが算出される。

#### 受入基準

1. WHEN インセンティブを計算する THEN 購入日時点でのユーザーレベルを使用する
2. WHEN 購入時点のレベルが特定される THEN そのレベルの商品価格を使用してインセンティブ単価を計算する
3. WHEN 販売者と購入者の両方にレベル履歴がある THEN 両者の購入時点でのレベルを使用する

### 要件4: 既存データの移行

**ユーザーストーリー:** 管理者として、既存のユーザーデータをレベル履歴システムに移行したい。そうすることで、過去のデータも新しいシステムで管理できる。

#### 受入基準

1. WHEN 移行処理を実行する THEN 既存の全ユーザーに対して履歴レコードが作成される
2. WHEN 履歴レコードが作成される THEN 有効開始日時はユーザー作成日時に設定される
3. WHEN 移行が完了する THEN 既存のインセンティブ計算結果と整合性が保たれる

### 要件5: 管理画面での履歴表示

**ユーザーストーリー:** 管理者として、ユーザーのレベル変更履歴を確認したい。そうすることで、レベル変更の経緯を把握し、必要に応じて修正できる。

#### 受入基準

1. WHEN ユーザー詳細画面を表示する THEN レベル変更履歴が時系列で表示される
2. WHEN 履歴を表示する THEN 各レベルの有効期間が明確に示される
3. WHEN 現在のレベルを表示する THEN 他の履歴と区別して表示される

## 技術的制約

- 既存のインセンティブ計算ロジックとの互換性を保つ
- パフォーマンスへの影響を最小限に抑える
- データの整合性を保証する
- 大量の履歴データに対応できるスケーラブルな設計

## 成功基準

- レベル変更前後でインセンティブ計算が正確に行われる
- 過去の購入データに対するインセンティブが正しく再計算される
- 管理者がレベル履歴を簡単に確認・管理できる
- システムのパフォーマンスが維持される