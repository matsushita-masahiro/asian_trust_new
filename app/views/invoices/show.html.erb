<div class="container py-5 pt-5 mt-5">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-primary">ğŸ“‹ è«‹æ±‚æ›¸ç¢ºèª</h2>
        <div>
          <% if @invoice.draft? %>
            <%= link_to "ç·¨é›†", edit_invoice_path(@invoice), class: "btn btn-outline-warning me-2" %>
          <% end %>
          <%= link_to "è«‹æ±‚æ›¸ç®¡ç†ã«æˆ»ã‚‹", invoices_path, class: "btn btn-outline-secondary" %>
        </div>
      </div>
    </div>
  </div>

  <!-- è«‹æ±‚æ›¸ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card shadow">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <h5 class="mb-0">è«‹æ±‚æ›¸ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h5>
          <div>
            <% if @invoice.sent_at.present? %>
              <span class="badge bg-success">é€ä»˜æ¸ˆã¿</span>
              <small class="text-muted ms-2"><%= @invoice.sent_at.strftime("%Y/%m/%d %H:%M") %></small>
            <% else %>
              <span class="badge bg-secondary">æœªé€ä»˜</span>
            <% end %>
          </div>
        </div>
        <div class="card-body">
          <!-- è«‹æ±‚æ›¸ã®PDFé¢¨è¡¨ç¤º -->
          <div class="invoice-preview p-4" style="background: white; border: 1px solid #ddd;">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="row mb-4">
              <div class="col-6">
                <h3 class="text-primary">è«‹æ±‚æ›¸</h3>
                <p class="mb-1">è«‹æ±‚æ›¸ç•ªå·: INV-<%= @invoice.id.to_s.rjust(6, '0') %></p>
                <p class="mb-1">ç™ºè¡Œæ—¥: <%= @invoice.invoice_date&.strftime("%Yå¹´%mæœˆ%dæ—¥") %></p>
                <p class="mb-0">æ”¯æ‰•æœŸé™: <%= @invoice.due_date&.strftime("%Yå¹´%mæœˆ%dæ—¥") %></p>
              </div>
              <div class="col-6 text-end">
                <% if current_user.invoice_base %>
                  <h5><%= current_user.invoice_base.company_name %></h5>
                  <% if current_user.invoice_base.department.present? %>
                    <p class="mb-1"><%= current_user.invoice_base.department %></p>
                  <% end %>
                  <% if current_user.invoice_base.address.present? %>
                    <p class="mb-1"><%= current_user.invoice_base.address %></p>
                  <% end %>
                  <% if current_user.invoice_base.email.present? %>
                    <p class="mb-0"><%= current_user.invoice_base.email %></p>
                  <% end %>
                <% else %>
                  <h5><%= current_user.name || current_user.email %></h5>
                <% end %>
              </div>
            </div>

            <hr>

            <!-- è«‹æ±‚å…ˆæƒ…å ± -->
            <div class="row mb-4">
              <div class="col-12">
                <h6 class="text-muted">è«‹æ±‚å…ˆ</h6>
                <% if @invoice.invoice_recipient %>
                  <p class="mb-1"><strong><%= @invoice.invoice_recipient.name %></strong></p>
                  <% if @invoice.invoice_recipient.representative_name.present? %>
                    <p class="mb-1"><%= @invoice.invoice_recipient.representative_name %> æ§˜</p>
                  <% end %>
                  <% if @invoice.invoice_recipient.department.present? %>
                    <p class="mb-1"><%= @invoice.invoice_recipient.department %></p>
                  <% end %>
                  <% if @invoice.invoice_recipient.address.present? %>
                    <p class="mb-1"><%= @invoice.invoice_recipient.address %></p>
                  <% end %>
                <% end %>
              </div>
            </div>

            <!-- è«‹æ±‚é‡‘é¡ -->
            <div class="row mb-4">
              <div class="col-12">
                <div class="bg-light p-3 rounded">
                  <div class="row">
                    <div class="col-8">
                      <h5 class="mb-0">è«‹æ±‚é‡‘é¡</h5>
                    </div>
                    <div class="col-4 text-end">
                      <h4 class="text-primary mb-0">Â¥<%= number_with_delimiter(@invoice.total_amount) %></h4>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- å‚™è€ƒ -->
            <% if @invoice.notes.present? %>
              <div class="row mb-4">
                <div class="col-12">
                  <h6 class="text-muted">å‚™è€ƒ</h6>
                  <p><%= simple_format(@invoice.notes) %></p>
                </div>
              </div>
            <% end %>

            <!-- æŒ¯è¾¼å…ˆæƒ…å ± -->
            <div class="row">
              <div class="col-12">
                <h6 class="text-muted">ãŠæŒ¯è¾¼å…ˆ</h6>
                <div class="table-responsive">
                  <table class="table table-sm table-borderless">
                    <tr>
                      <td width="20%">éŠ€è¡Œå:</td>
                      <td><%= @invoice.bank_name %></td>
                    </tr>
                    <tr>
                      <td>æ”¯åº—å:</td>
                      <td><%= @invoice.bank_branch_name %></td>
                    </tr>
                    <tr>
                      <td>å£åº§ç¨®åˆ¥:</td>
                      <td>
                        <% if @invoice.bank_account_type == 'savings' %>
                          æ™®é€š
                        <% elsif @invoice.bank_account_type == 'checking' %>
                          å½“åº§
                        <% else %>
                          <%= @invoice.bank_account_type %>
                        <% end %>
                      </td>
                    </tr>
                    <tr>
                      <td>å£åº§ç•ªå·:</td>
                      <td><%= @invoice.bank_account_number %></td>
                    </tr>
                    <tr>
                      <td>å£åº§åç¾©:</td>
                      <td><%= @invoice.bank_account_name %></td>
                    </tr>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
  <div class="row justify-content-center mt-4">
    <div class="col-md-8">
      <div class="card shadow">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="mb-1">è«‹æ±‚æ›¸ã®é€ä»˜</h6>
              <small class="text-muted">
                <% if @invoice.sent_at.present? %>
                  ã“ã®è«‹æ±‚æ›¸ã¯ <%= @invoice.sent_at.strftime("%Yå¹´%mæœˆ%dæ—¥ %H:%M") %> ã«é€ä»˜æ¸ˆã¿ã§ã™ã€‚
                <% else %>
                  å†…å®¹ã‚’ç¢ºèªå¾Œã€è«‹æ±‚æ›¸ã‚’é€ä»˜ã—ã¦ãã ã•ã„ã€‚
                <% end %>
              </small>
            </div>
            <div>
              <% if @invoice.sent_at.present? %>
                <%= button_to "å†é€ä»˜", send_invoice_invoice_path(@invoice), method: :patch, 
                    class: "btn btn-outline-primary", 
                    data: { confirm: "è«‹æ±‚æ›¸ã‚’å†é€ä»˜ã—ã¾ã™ã‹ï¼Ÿ" } %>
              <% else %>
                <%= button_to "è«‹æ±‚æ›¸ã‚’é€ä»˜", send_invoice_invoice_path(@invoice), method: :patch, 
                    class: "btn btn-success btn-lg", 
                    data: { confirm: "è«‹æ±‚æ›¸ã‚’é€ä»˜ã—ã¾ã™ã‹ï¼Ÿé€ä»˜å¾Œã¯ç·¨é›†ã§ãã¾ã›ã‚“ã€‚" } %>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.invoice-preview {
  font-family: 'Helvetica Neue', Arial, sans-serif;
  line-height: 1.6;
}

.invoice-preview h3, .invoice-preview h5, .invoice-preview h6 {
  margin-bottom: 0.5rem;
}

.invoice-preview p {
  margin-bottom: 0.25rem;
}

@media print {
  .invoice-preview {
    box-shadow: none !important;
    border: none !important;
  }
}
</style>