<div class="container py-5 pt-5 mt-5">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="text-primary">ğŸ“‹ è«‹æ±‚æ›¸ç¢ºèª</h4>
        <div>
          <% if @invoice.draft? %>
            <%= link_to "ç·¨é›†", edit_invoice_path(@invoice), class: "btn btn-outline-warning me-2" %>
          <% end %>
          <%= link_to "è«‹æ±‚æ›¸ç®¡ç†ã«æˆ»ã‚‹", invoices_path, class: "btn btn-outline-secondary" %>
        </div>
      </div>
    </div>
  </div>

  <!-- è«‹æ±‚æ›¸ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card shadow">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <h5 class="mb-0">è«‹æ±‚æ›¸ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h5>
          <div>
            <% if @invoice.sent_at.present? %>
              <span class="badge bg-success">é€ä»˜æ¸ˆã¿</span>
              <small class="text-muted ms-2"><%= @invoice.sent_at.strftime("%Y/%m/%d %H:%M") %></small>
            <% else %>
              <span class="badge bg-secondary">æœªé€ä»˜</span>
            <% end %>
          </div>
        </div>
        <div class="card-body">
          <!-- è«‹æ±‚æ›¸ã®PDFé¢¨è¡¨ç¤º -->
          <div class="invoice-preview p-4" style="background: white; border: 1px solid #ddd;">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="row mb-4">
              <!-- ã‚¹ãƒãƒ›æ™‚ã¯è«‹æ±‚å…ˆæƒ…å ±ã‚’ä¸Šã«è¡¨ç¤º -->
              <div class="col-12 d-md-none mb-3">
                <% if @invoice.invoice_recipient %>
                  <h5><%= @invoice.invoice_recipient.name %></h5>
                  <% if @invoice.invoice_recipient.representative_name.present? %>
                    <p class="mb-1"><%= @invoice.invoice_recipient.representative_name %> æ§˜</p>
                  <% end %>
                  <% if @invoice.invoice_recipient.department.present? %>
                    <p class="mb-1"><%= @invoice.invoice_recipient.department %></p>
                  <% end %>
                  <% if @invoice.invoice_recipient.address.present? %>
                    <p class="mb-1"><%= @invoice.invoice_recipient.address %></p>
                  <% end %>
                  <% if @invoice.invoice_recipient.email.present? %>
                    <p class="mb-0"><%= @invoice.invoice_recipient.email %></p>
                  <% end %>
                <% end %>
              </div>
              
              <!-- è«‹æ±‚æ›¸æƒ…å ± -->
              <div class="col-12 col-md-6">
                <h3 class="text-primary">è«‹æ±‚æ›¸</h3>
                <p class="mb-1">è«‹æ±‚æ›¸ç•ªå·: INV-<%= @invoice.id.to_s.rjust(6, '0') %></p>
                <p class="mb-1">ç™ºè¡Œæ—¥: <%= @invoice.invoice_date&.strftime("%Yå¹´%mæœˆ%dæ—¥") %></p>
                <p class="mb-0">æ”¯æ‰•æœŸé™: <%= @invoice.due_date&.strftime("%Yå¹´%mæœˆ%dæ—¥") %></p>
              </div>
              
              <!-- ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—æ™‚ã®è«‹æ±‚å…ˆæƒ…å ± -->
              <div class="col-md-6 text-end d-none d-md-block">
                <% if @invoice.invoice_recipient %>
                  <h5><%= @invoice.invoice_recipient.name %></h5>
                  <% if @invoice.invoice_recipient.representative_name.present? %>
                    <p class="mb-1"><%= @invoice.invoice_recipient.representative_name %> æ§˜</p>
                  <% end %>
                  <% if @invoice.invoice_recipient.department.present? %>
                    <p class="mb-1"><%= @invoice.invoice_recipient.department %></p>
                  <% end %>
                  <% if @invoice.invoice_recipient.address.present? %>
                    <p class="mb-1"><%= @invoice.invoice_recipient.address %></p>
                  <% end %>
                  <% if @invoice.invoice_recipient.email.present? %>
                    <p class="mb-0"><%= @invoice.invoice_recipient.email %></p>
                  <% end %>
                <% end %>
              </div>
            </div>

            <hr>

            <!-- è«‹æ±‚å…ƒæƒ…å ± -->
            <div class="row mb-4">
              <div class="col-12">
                <% if current_user.invoice_base %>
                  <p class="mb-1"><strong><%= current_user.invoice_base.company_name %></strong></p>
                  <% if current_user.invoice_base.department.present? %>
                    <p class="mb-1"><%= current_user.invoice_base.department %></p>
                  <% end %>
                  <% if current_user.invoice_base.address.present? %>
                    <p class="mb-1"><%= current_user.invoice_base.address %></p>
                  <% end %>
                  <% if current_user.invoice_base.email.present? %>
                    <p class="mb-1"><%= current_user.invoice_base.email %></p>
                  <% end %>
                <% else %>
                  <p class="mb-1"><strong><%= current_user.name || current_user.email %></strong></p>
                <% end %>
              </div>
            </div>

            <!-- è«‹æ±‚é‡‘é¡ -->
            <div class="row mb-4">
              <div class="col-12">
                <div class="bg-light p-3 rounded">
                  <!-- ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—è¡¨ç¤º -->
                  <div class="row d-none d-md-flex">
                    <div class="col-8">
                      <h5 class="mb-0">è«‹æ±‚é‡‘é¡</h5>
                    </div>
                    <div class="col-4 text-end">
                      <h4 class="text-primary mb-0">Â¥<%= number_with_delimiter(@invoice.total_amount) %></h4>
                    </div>
                  </div>
                  <!-- ã‚¹ãƒãƒ›è¡¨ç¤º -->
                  <div class="d-md-none text-center">
                    <h6 class="mb-2 text-muted">è«‹æ±‚é‡‘é¡</h6>
                    <h3 class="text-primary mb-0">Â¥<%= number_with_delimiter(@invoice.total_amount) %></h3>
                  </div>
                </div>
              </div>
            </div>

            <!-- å‚™è€ƒ -->
            <% if @invoice.notes.present? %>
              <div class="row mb-4">
                <div class="col-12">
                  <h6 class="text-muted">å‚™è€ƒ</h6>
                  <p><%= simple_format(@invoice.notes) %></p>
                </div>
              </div>
            <% end %>

            <!-- æŒ¯è¾¼å…ˆæƒ…å ± -->
            <div class="row">
              <div class="col-12">
                <h6 class="text-muted">ãŠæŒ¯è¾¼å…ˆ</h6>
                <!-- ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—è¡¨ç¤º -->
                <div class="table-responsive d-none d-md-block">
                  <table class="table table-sm table-borderless">
                    <tr>
                      <td width="20%">éŠ€è¡Œå:</td>
                      <td><%= @invoice.bank_name %></td>
                    </tr>
                    <tr>
                      <td>æ”¯åº—å:</td>
                      <td><%= @invoice.bank_branch_name %></td>
                    </tr>
                    <tr>
                      <td>å£åº§ç¨®åˆ¥:</td>
                      <td>
                        <% if @invoice.bank_account_type == 'savings' %>
                          æ™®é€š
                        <% elsif @invoice.bank_account_type == 'checking' %>
                          å½“åº§
                        <% else %>
                          <%= @invoice.bank_account_type %>
                        <% end %>
                      </td>
                    </tr>
                    <tr>
                      <td>å£åº§ç•ªå·:</td>
                      <td><%= @invoice.bank_account_number %></td>
                    </tr>
                    <tr>
                      <td>å£åº§åç¾©:</td>
                      <td><%= @invoice.bank_account_name %></td>
                    </tr>
                  </table>
                </div>
                
                <!-- ã‚¹ãƒãƒ›è¡¨ç¤º -->
                <div class="d-md-none bank-info-mobile">
                  <div class="bank-item">
                    <span class="bank-label">éŠ€è¡Œå:</span>
                    <span class="bank-value"><%= @invoice.bank_name %></span>
                  </div>
                  <div class="bank-item">
                    <span class="bank-label">æ”¯åº—å:</span>
                    <span class="bank-value"><%= @invoice.bank_branch_name %></span>
                  </div>
                  <div class="bank-item">
                    <span class="bank-label">å£åº§ç¨®åˆ¥:</span>
                    <span class="bank-value">
                      <% if @invoice.bank_account_type == 'savings' %>
                        æ™®é€š
                      <% elsif @invoice.bank_account_type == 'checking' %>
                        å½“åº§
                      <% else %>
                        <%= @invoice.bank_account_type %>
                      <% end %>
                    </span>
                  </div>
                  <div class="bank-item">
                    <span class="bank-label">å£åº§ç•ªå·:</span>
                    <span class="bank-value"><%= @invoice.bank_account_number %></span>
                  </div>
                  <div class="bank-item">
                    <span class="bank-label">å£åº§åç¾©:</span>
                    <span class="bank-value"><%= @invoice.bank_account_name %></span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ã‚¤ãƒ³ã‚»ãƒ³ãƒ†ã‚£ãƒ–æ˜ç´° -->
  <div class="row justify-content-center mt-4">
    <div class="col-md-8">
      <div class="card shadow">
        <div class="card-header bg-light">
          <h5 class="mb-0">ğŸ“Š ã‚¤ãƒ³ã‚»ãƒ³ãƒ†ã‚£ãƒ–æ˜ç´° (<%= Date.strptime(@selected_month, "%Y-%m").strftime("%Yå¹´%mæœˆ") %>)</h5>
        </div>
        <div class="card-body">
          <% if @bonus_details && @bonus_details.any? %>
            <!-- ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—è¡¨ç¤º -->
            <div class="table-responsive d-none d-md-block">
              <table class="table table-hover align-middle">
                <thead class="table-light">
                  <tr>
                    <th>ç¨®åˆ¥</th>
                    <th>è²©å£²è€…</th>
                    <th>å•†å“å</th>
                    <th class="text-end">æ•°é‡</th>
                    <th class="text-end">å˜ä¾¡</th>
                    <th class="text-end">é‡‘é¡</th>
                    <th>æ—¥ä»˜</th>
                  </tr>
                </thead>
                <tbody>
                  <% total_amount = 0 %>
                  <% @bonus_details.each do |detail| %>
                    <% total_amount += detail[:total_bonus] %>
                    <tr>
                      <td>
                        <% if detail[:type] == 'è‡ªå·±è²©å£²' %>
                          <span class="badge bg-primary">è‡ªå·±è²©å£²</span>
                        <% else %>
                          <span class="badge bg-success">ä¸‹ä½è²©å£²</span>
                        <% end %>
                      </td>
                      <td><%= detail[:user_name] %></td>
                      <td><%= detail[:product_name] %></td>
                      <td class="text-end"><%= detail[:quantity] %></td>
                      <td class="text-end">Â¥<%= number_with_delimiter(detail[:unit_bonus]) %></td>
                      <td class="text-end text-success fw-bold">Â¥<%= number_with_delimiter(detail[:total_bonus]) %></td>
                      <td><%= detail[:purchased_at]&.strftime("%m/%d") %></td>
                    </tr>
                  <% end %>
                </tbody>
                <tfoot class="table-light">
                  <tr>
                    <th colspan="5" class="text-end">åˆè¨ˆ</th>
                    <th class="text-end text-success">Â¥<%= number_with_delimiter(total_amount) %></th>
                    <th></th>
                  </tr>
                </tfoot>
              </table>
            </div>

            <!-- ã‚¹ãƒãƒ›è¡¨ç¤ºï¼ˆå›ºå®šåˆ— + æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‰ -->
            <div class="d-md-none">
              <div class="mobile-table-container">
                <table class="table table-hover align-middle mobile-table">
                  <thead class="table-light">
                    <tr>
                      <th class="fixed-col-1">ç¨®åˆ¥</th>
                      <th class="fixed-col-2">è²©å£²è€…</th>
                      <th class="scroll-col">å•†å“å</th>
                      <th class="scroll-col text-end">æ•°é‡</th>
                      <th class="scroll-col text-end">å˜ä¾¡</th>
                      <th class="scroll-col text-end">é‡‘é¡</th>
                      <th class="scroll-col">æ—¥ä»˜</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% total_amount = 0 %>
                    <% @bonus_details.each do |detail| %>
                      <% total_amount += detail[:total_bonus] %>
                      <tr>
                        <td class="fixed-col-1">
                          <% if detail[:type] == 'è‡ªå·±è²©å£²' %>
                            <span class="badge bg-primary">è‡ªå·±è²©å£²</span>
                          <% else %>
                            <span class="badge bg-success">ä¸‹ä½è²©å£²</span>
                          <% end %>
                        </td>
                        <td class="fixed-col-2"><%= detail[:user_name] %></td>
                        <td class="scroll-col"><%= detail[:product_name] %></td>
                        <td class="scroll-col text-end"><%= detail[:quantity] %></td>
                        <td class="scroll-col text-end">Â¥<%= number_with_delimiter(detail[:unit_bonus]) %></td>
                        <td class="scroll-col text-end text-success fw-bold">Â¥<%= number_with_delimiter(detail[:total_bonus]) %></td>
                        <td class="scroll-col"><%= detail[:purchased_at]&.strftime("%m/%d") %></td>
                      </tr>
                    <% end %>
                  </tbody>
                  <tfoot class="table-light">
                    <tr>
                      <th class="fixed-col-1"></th>
                      <th class="fixed-col-2">åˆè¨ˆ</th>
                      <th class="scroll-col"></th>
                      <th class="scroll-col"></th>
                      <th class="scroll-col"></th>
                      <th class="scroll-col text-end text-success">Â¥<%= number_with_delimiter(total_amount) %></th>
                      <th class="scroll-col"></th>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>
            
            <!-- ã‚µãƒãƒªãƒ¼æƒ…å ± -->
            <div class="row mt-3">
              <div class="col-md-6">
                <div class="card bg-light">
                  <div class="card-body text-center">
                    <h6 class="card-title text-muted">è‡ªå·±è²©å£²ä»¶æ•°</h6>
                    <h4 class="text-primary mb-0"><%= @bonus_details.count { |d| d[:type] == 'è‡ªå·±è²©å£²' } %>ä»¶</h4>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card bg-light">
                  <div class="card-body text-center">
                    <h6 class="card-title text-muted">ä¸‹ä½è²©å£²ä»¶æ•°</h6>
                    <h4 class="text-success mb-0"><%= @bonus_details.count { |d| d[:type] == 'ä¸‹ä½è²©å£²' } %>ä»¶</h4>
                  </div>
                </div>
              </div>
            </div>
          <% else %>
            <div class="text-center py-5">
              <i class="fas fa-info-circle fa-3x text-muted mb-3"></i>
              <h5 class="text-muted">æ˜ç´°ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</h5>
              <p class="text-muted">é¸æŠã—ãŸæœˆï¼ˆ<%= Date.strptime(@selected_month, "%Y-%m").strftime("%Yå¹´%mæœˆ") %>ï¼‰ã«ã¯ã‚¤ãƒ³ã‚»ãƒ³ãƒ†ã‚£ãƒ–æ˜ç´°ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
  <div class="row justify-content-center mt-4">
    <div class="col-md-8">
      <div class="card shadow">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="mb-1">è«‹æ±‚æ›¸ã®é€ä»˜</h6>
              <small class="text-muted">
                <% if @invoice.sent_at.present? %>
                  ã“ã®è«‹æ±‚æ›¸ã¯ <%= @invoice.sent_at.strftime("%Yå¹´%mæœˆ%dæ—¥ %H:%M") %> ã«é€ä»˜æ¸ˆã¿ã§ã™ã€‚
                <% else %>
                  å†…å®¹ã‚’ç¢ºèªå¾Œã€è«‹æ±‚æ›¸ã‚’é€ä»˜ã—ã¦ãã ã•ã„ã€‚
                <% end %>
              </small>
            </div>
            <div>
              <% if @invoice.sent_at.present? %>
                <%= button_to "å†é€ä»˜", send_invoice_invoice_path(@invoice), method: :patch, 
                    class: "btn btn-outline-primary", 
                    data: { confirm: "è«‹æ±‚æ›¸ã‚’å†é€ä»˜ã—ã¾ã™ã‹ï¼Ÿ" } %>
              <% else %>
                <%= button_to "è«‹æ±‚æ›¸ã‚’é€ä»˜", send_invoice_invoice_path(@invoice), method: :patch, 
                    class: "btn btn-success btn-lg", 
                    data: { confirm: "è«‹æ±‚æ›¸ã‚’é€ä»˜ã—ã¾ã™ã‹ï¼Ÿé€ä»˜å¾Œã¯ç·¨é›†ã§ãã¾ã›ã‚“ã€‚" } %>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.invoice-preview {
  font-family: 'Helvetica Neue', Arial, sans-serif;
  line-height: 1.6;
}

.invoice-preview h3, .invoice-preview h5, .invoice-preview h6 {
  margin-bottom: 0.5rem;
}

.invoice-preview p {
  margin-bottom: 0.25rem;
}

@media print {
  .invoice-preview {
    box-shadow: none !important;
    border: none !important;
  }
}

/* ã‚¹ãƒãƒ›ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
.mobile-table-container {
  position: relative;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}

.mobile-table {
  min-width: 600px;
}

.mobile-table .fixed-col-1,
.mobile-table .fixed-col-2 {
  position: sticky;
  background-color: white;
  z-index: 10;
}

.mobile-table .fixed-col-1 {
  left: 0;
  min-width: 80px;
  border-right: 2px solid #dee2e6;
}

.mobile-table .fixed-col-2 {
  left: 80px;
  min-width: 100px;
  border-right: 2px solid #dee2e6;
}

.mobile-table thead .fixed-col-1,
.mobile-table thead .fixed-col-2 {
  background-color: #f8f9fa !important;
}

.mobile-table tfoot .fixed-col-1,
.mobile-table tfoot .fixed-col-2 {
  background-color: #f8f9fa !important;
}

.mobile-table .scroll-col {
  min-width: 100px;
}

/* ãƒãƒƒã‚¸ã®ã‚µã‚¤ã‚ºèª¿æ•´ */
@media (max-width: 767px) {
  .badge {
    font-size: 0.7em;
    padding: 0.25em 0.4em;
  }
}

/* ã‚¹ãƒãƒ›ç”¨éŠ€è¡Œæƒ…å ±ã‚¹ã‚¿ã‚¤ãƒ« */
.bank-info-mobile {
  font-size: 14px;
}

.bank-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 0;
  border-bottom: 1px solid #f0f0f0;
  white-space: nowrap;
  overflow: hidden;
}

.bank-item:last-child {
  border-bottom: none;
}

.bank-label {
  color: #666;
  font-weight: 500;
  min-width: 80px;
  flex-shrink: 0;
}

.bank-value {
  text-align: right;
  font-weight: 600;
  color: #333;
  overflow: hidden;
  text-overflow: ellipsis;
  margin-left: 10px;
}
</style>