# ユーザーレベル履歴管理機能 実装タスク

## フェーズ1: データベース基盤とモデル実装

- [ ] 1. user_level_historiesテーブルの作成
  - マイグレーションファイルを作成してテーブル構造を定義
  - 必要なインデックスを追加（user_id, effective_dates, changed_by等）
  - 外部キー制約を設定
  - _要件: 1.1, 1.2_

- [ ] 2. UserLevelHistoryモデルの実装
  - モデルファイルを作成してリレーションを定義
  - バリデーションルールを実装（effective_from, change_reason必須等）
  - スコープメソッドを実装（effective_at, current, historical等）
  - _要件: 1.1, 1.2_

- [ ] 3. Userモデルの拡張
  - user_level_historiesとのリレーション追加
  - level_at(datetime)メソッドの実装
  - product_price_at(product, datetime)メソッドの実装
  - update_level_history(new_level_id)メソッドの実装
  - _要件: 2.1, 2.2_

## フェーズ2: 既存データ移行

- [ ] 4. 既存ユーザーデータの履歴化
  - 全既存ユーザーに対して初期履歴レコードを作成
  - effective_fromをユーザー作成日時に設定
  - データ整合性チェック機能を実装
  - _要件: 4.1, 4.2, 4.3_

- [ ] 5. 移行データの検証
  - 移行前後のデータ整合性確認
  - 既存のインセンティブ計算結果との比較
  - 移行結果のレポート生成機能
  - _要件: 4.3_

## フェーズ3: インセンティブ計算の履歴ベース化

- [ ] 6. incentive_unit_price_for_itemメソッドの更新
  - 購入時点でのレベルを使用する計算ロジックに変更
  - 自分の販売と他人の販売の場合分けを実装
  - 負の値の場合の0返却処理を維持
  - _要件: 3.1, 3.2_

- [ ] 7. bonus_for_purchase_itemメソッドの更新
  - incentive_unit_price_for_itemを使用したシンプルな計算に変更
  - 数量との掛け算処理を実装
  - _要件: 3.1, 3.2_

- [ ] 8. bonus_in_periodメソッドの履歴ベース化
  - 自分の販売に対するボーナス計算を履歴ベースに変更
  - 子孫の販売に対するボーナス計算を履歴ベースに変更
  - 購入時点での両者のレベルを使用する階層差額計算を実装
  - _要件: 3.1, 3.2, 3.3_

- [ ] 9. 計算結果の検証機能
  - 新旧計算方式の結果比較機能を実装
  - フィーチャーフラグによる計算方式切り替え機能
  - 計算結果の差異レポート生成機能
  - _要件: 3.1, 3.2_

## フェーズ4: 請求書・領収書システムの更新

- [ ] 10. Invoiceモデルの履歴ベース化
  - calculate_monthly_incentiveメソッドを履歴ベース計算に変更
  - 対象月の期間設定とbonus_in_period呼び出しを実装
  - _要件: 3.1, 3.2_

- [ ] 11. 領収書システムの履歴ベース化
  - 個別購入インセンティブ計算を履歴ベースに変更
  - bonus_for_purchase_itemメソッドを使用した計算に更新
  - _要件: 3.1, 3.2_

- [ ] 12. 既存請求書データの再計算機能
  - 過去の請求書データを履歴ベースで再計算する機能を実装
  - 計算結果の差異を表示する機能を追加
  - 管理者が再計算を実行できるインターフェースを作成
  - _要件: 3.1, 3.2_

## フェーズ5: 管理画面のレベル変更機能

- [ ] 13. ユーザー編集画面の拡張
  - 既存のadmin/users/edit画面にレベル変更セクションを追加
  - レベル選択ドロップダウンと変更理由入力欄を実装
  - 管理者パスワード再認証フィールドを追加
  - _要件: 5.1, 5.2_

- [ ] 14. レベル変更時のセキュリティ機能
  - 管理者パスワード再認証処理を実装
  - 権限チェック（管理者のみ、自己変更禁止等）を実装
  - IPアドレス記録機能を追加
  - _要件: 5.1, 5.2_

- [ ] 15. JavaScript確認機能
  - レベル変更時の確認ダイアログを実装
  - 変更理由とパスワードの入力チェック機能
  - 変更前後のレベル比較表示機能
  - _要件: 5.1, 5.2_

- [ ] 16. レベル変更処理の実装
  - update_level_historyメソッドを使用した変更処理
  - トランザクション処理による整合性保証
  - 成功・失敗時のフラッシュメッセージ表示
  - _要件: 5.1, 5.2_

## フェーズ6: 履歴表示と管理機能

- [ ] 17. ユーザー詳細画面でのレベル履歴表示
  - レベル変更履歴を時系列で表示する機能を実装
  - 各レベルの有効期間を明確に表示
  - 現在のレベルを他の履歴と区別して表示
  - _要件: 5.3_

- [ ] 18. レベル変更履歴一覧画面
  - 全ユーザーのレベル変更履歴を一覧表示する画面を作成
  - 日付範囲、ユーザー名、レベルでの絞り込み機能を実装
  - CSV出力機能を追加
  - _要件: 5.3_

- [ ] 19. 過去のインセンティブ再計算機能
  - 特定ユーザーの過去のインセンティブを再計算する機能
  - レベル変更の影響分析機能を実装
  - 計算結果の比較表示機能を追加
  - _要件: 5.3_

## フェーズ7: 管理画面・API・バッチ処理の更新

- [ ] 20. 管理画面のレポート・統計機能の更新
  - ダッシュボードの統計情報を履歴ベース計算に変更
  - ユーザー一覧でのレベル表示を履歴考慮に更新
  - 売上・インセンティブ集計を履歴ベースに変更
  - _要件: 3.1, 3.2_

- [ ] 21. データエクスポート機能の更新
  - CSV出力時のインセンティブ計算を履歴ベースに変更
  - レポート生成時の計算を履歴ベースに更新
  - レベル履歴情報を含むエクスポート機能を追加
  - _要件: 3.1, 3.2_

- [ ] 22. API レスポンスの更新
  - ユーザー情報APIにレベル履歴情報を追加
  - インセンティブ計算APIを履歴ベースに変更
  - レベル変更API（管理者用）を実装
  - _要件: 3.1, 3.2_

- [ ] 23. 月次集計バッチの履歴ベース化
  - 月次集計バッチを履歴ベース計算に変更
  - データ整合性チェックバッチを実装
  - 履歴データのクリーンアップバッチを作成
  - _要件: 3.1, 3.2_

## フェーズ8: パフォーマンス最適化とテスト

- [ ] 24. データベースクエリの最適化
  - 履歴検索クエリのパフォーマンス最適化
  - 必要なインデックスの追加・調整
  - 大量データ処理時のバッチ最適化
  - _要件: 3.1, 3.2_

- [ ] 25. キャッシュ機能の実装
  - 頻繁にアクセスされる現在レベルのキャッシュ
  - インセンティブ計算結果のキャッシュ機能
  - キャッシュ無効化処理の実装
  - _要件: 3.1, 3.2_

- [ ] 26. 単体テストの実装
  - UserLevelHistoryモデルのテスト
  - Userモデルの拡張メソッドのテスト
  - インセンティブ計算ロジックのテスト
  - _要件: 1.1, 2.1, 3.1_

- [ ] 27. 統合テストの実装
  - レベル変更フローのテスト
  - 履歴ベースインセンティブ計算の正確性テスト
  - 管理画面でのレベル変更操作のテスト
  - _要件: 5.1, 5.2, 3.1_

- [ ] 28. パフォーマンステストの実装
  - 大量履歴データでの検索性能テスト
  - インセンティブ計算の処理時間テスト
  - 同時アクセス時の整合性テスト
  - _要件: 3.1, 3.2_

## フェーズ9: 運用機能とドキュメント

- [ ] 29. 監視・アラート機能の実装
  - 履歴検索クエリの実行時間監視
  - 履歴テーブルのサイズ増加監視
  - インセンティブ計算結果の異常値検知
  - _要件: 3.1, 3.2_

- [ ] 30. データ管理機能の実装
  - 履歴データのアーカイブ機能
  - データ整合性チェック機能
  - 履歴データのクリーンアップ機能
  - _要件: 4.1, 4.2_

- [ ] 31. 運用ドキュメントの作成
  - レベル変更操作マニュアルの作成
  - データ移行手順書の作成
  - 障害時の復旧手順書の作成
  - _要件: 5.1, 5.2_

- [ ] 32. 最終検証とリリース準備
  - 全機能の統合テスト実行
  - 本番環境での動作確認
  - ロールバック手順の確認
  - _要件: 1.1, 2.1, 3.1, 4.1, 5.1_