<div class="container-fluid" style="padding-top: 100px;">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="text-primary">管理ダッシュボード</h4>
        <div class="d-flex align-items-center gap-3">
          <% unconfirmed_invoices_count = Invoice.where(status: Invoice::SENT).count %>
          <% if unconfirmed_invoices_count > 0 %>
            <%= link_to admin_invoice_status_index_path, class: "btn btn-danger btn-sm d-flex align-items-center gap-2" do %>
              <i class="fas fa-exclamation-triangle"></i>
              未確認請求書有（<%= unconfirmed_invoices_count %>）
            <% end %>
          <% end %>
          <div class="text-muted">
            <%= Time.current.strftime("%Y/%m/%d") %> (<%= %w[日 月 火 水 木 金 土][Time.current.wday] %>)
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- 統計カード -->
    <div class="col-md-3 mb-4">
      <div class="card bg-primary text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h6 class="card-title">総ユーザー数</h6>
              <h3 class="mb-0"><%= User.count %></h3>
            </div>
            <div class="align-self-center">
              <i class="fas fa-users fa-2x opacity-75"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-3 mb-4">
      <div class="card bg-success text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h6 class="card-title">今月の登録</h6>
              <h3 class="mb-0"><%= User.where(created_at: Date.current.beginning_of_month..Date.current.end_of_month).count %></h3>
            </div>
            <div class="align-self-center">
              <i class="fas fa-user-plus fa-2x opacity-75"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-3 mb-4">
      <div class="card bg-info text-white">
        <div class="card-body">
          <% if @pending_payments_count > 0 %>
            <div class="alert alert-warning text-dark mb-2 py-1 px-2" style="font-size: 0.8rem;">
              <i class="fas fa-exclamation-triangle"></i>
              未入金注文: <strong><%= @pending_payments_count %>件</strong>
            </div>
          <% end %>
          <div class="d-flex justify-content-between">
            <div>
              <h6 class="card-title">今日のアクセス</h6>
              <h3 class="mb-0"><%= @today_access_count %></h3>
            </div>
            <div class="align-self-center">
              <i class="fas fa-chart-line fa-2x opacity-75"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-3 mb-4">
      <% 
        status_class = case @system_health[:status]
                      when :normal then 'bg-success'
                      when :warning then 'bg-warning' 
                      when :error then 'bg-danger'
                      else 'bg-secondary'
                      end
        
        status_icon = case @system_health[:status]
                     when :normal then 'fa-check-circle'
                     when :warning then 'fa-exclamation-triangle'
                     when :error then 'fa-times-circle'
                     else 'fa-question-circle'
                     end
        
        status_text = case @system_health[:status]
                     when :normal then '正常'
                     when :warning then '警告'
                     when :error then 'エラー'
                     else '不明'
                     end
      %>
      
      <div class="card <%= status_class %> text-white system-status-card" 
           onclick="showSystemHealthDetails()">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h6 class="card-title">システム状態</h6>
              <h3 class="mb-0"><%= status_text %></h3>
              <small class="opacity-75">
                <%= @system_health[:checked_at]&.strftime("%H:%M更新") %>
              </small>
            </div>
            <div class="align-self-center">
              <i class="fas <%= status_icon %> fa-2x opacity-75"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- クイックアクション -->
    <div class="col-md-6 mb-4 order-1 order-md-1">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">クイックアクション</h5>
        </div>
        <div class="card-body">
          <div class="d-grid gap-2">
            <%= link_to "ユーザー管理", admin_users_path, class: "btn btn-outline-primary" %>
            <%= link_to "購入履歴", admin_purchases_path, class: "btn btn-outline-secondary" %>
            <%= link_to "お問い合わせ管理", admin_inquiries_path, class: "btn btn-outline-info" %>
            <%= link_to "商品管理", admin_products_path, class: "btn btn-outline-success" %>
            <%= link_to "支払いインセンティブ一覧", admin_bonuses_path, class: "btn btn-outline-warning" %>
            <%= link_to "請求書会社情報", admin_invoice_recipient_path, class: "btn btn-outline-danger" %>
            <%= link_to "請求書状況", admin_invoice_status_index_path, class: "btn btn-outline-primary" %>
            <%= link_to "全ユーザー階層図", all_users_admin_users_path, class: "btn btn-outline-dark" %>
          </div>
        </div>
      </div>
    </div>

    <!-- 最近のユーザー -->
    <div class="col-md-6 mb-4 order-2 order-md-2">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">最近登録されたユーザー</h5>
        </div>
        <div class="card-body">
          <% if User.exists? %>
            <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
              <table class="table table-sm">
                <thead class="sticky-top bg-light">
                  <tr>
                    <th>LステップID</th>
                    <th>メールアドレス</th>
                    <th>登録日</th>
                  </tr>
                </thead>
                <tbody>
                  <% User.order(created_at: :desc).each do |user| %>
                    <tr>
                      <td><%= user.lstep_user_id %></td>
                      <td><%= user.name %></td>
                      <td><%= user.created_at.strftime("%m/%d") %></td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          <% else %>
            <p class="text-muted text-center">まだユーザーが登録されていません</p>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- システム状態詳細モーダル -->
<div class="modal fade" id="systemHealthModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">システム状態詳細</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="systemHealthDetails">
        <div class="text-center">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">読み込み中...</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function showSystemHealthDetails() {
  // モーダルを表示
  const modal = new bootstrap.Modal(document.getElementById('systemHealthModal'));
  modal.show();
  
  // システム状態の詳細情報を表示
  const details = <%= raw @system_health.to_json %>;
  
  let html = '<div class="row">';
  
  // 全体ステータス
  const statusBadge = details.status === 'normal' ? 'bg-success' : 
                     details.status === 'warning' ? 'bg-warning' : 'bg-danger';
  
  html += `
    <div class="col-12 mb-3">
      <div class="alert alert-${details.status === 'normal' ? 'success' : details.status === 'warning' ? 'warning' : 'danger'}">
        <h6><span class="badge ${statusBadge}">${details.status === 'normal' ? '正常' : details.status === 'warning' ? '警告' : 'エラー'}</span> ${details.message}</h6>
        <small>最終チェック: ${new Date(details.checked_at).toLocaleString('ja-JP')}</small>
      </div>
    </div>
  `;
  
  // 各チェック項目の詳細
  if (details.details) {
    Object.keys(details.details).forEach(key => {
      const item = details.details[key];
      const itemName = {
        'database': 'データベース接続',
        'data_integrity': 'データ整合性',
        'error_logs': 'エラーログ',
        'background_jobs': 'バックグラウンドジョブ',
        'disk_space': 'ディスク容量',
        'memory_usage': 'メモリ使用量'
      }[key] || key;
      
      const itemBadge = item.status === 'normal' ? 'bg-success' : 
                       item.status === 'warning' ? 'bg-warning' : 'bg-danger';
      
      const itemStatus = item.status === 'normal' ? '正常' : 
                        item.status === 'warning' ? '警告' : 'エラー';
      
      html += `
        <div class="col-md-6 mb-3">
          <div class="card">
            <div class="card-header d-flex justify-content-between">
              <span>${itemName}</span>
              <span class="badge ${itemBadge}">${itemStatus}</span>
            </div>
            <div class="card-body">
              <p class="card-text">${item.message}</p>
            </div>
          </div>
        </div>
      `;
    });
  }
  
  html += '</div>';
  
  // 警告の場合は推奨アクションを表示
  if (details.status === 'warning' || details.status === 'error') {
    html += `
      <div class="alert alert-info mt-3">
        <h6><i class="fas fa-lightbulb"></i> 推奨アクション</h6>
        <ul class="mb-0">
    `;
    
    if (details.details) {
      Object.keys(details.details).forEach(key => {
        const item = details.details[key];
        if (item.status === 'warning' || item.status === 'error') {
          html += `<li>${item.message} - 確認が必要です</li>`;
        }
      });
    }
    
    html += `
        </ul>
      </div>
    `;
  }
  
  document.getElementById('systemHealthDetails').innerHTML = html;
}
</script>

<style>
.system-status-card {
  transition: all 0.3s ease;
  cursor: pointer;
}

.system-status-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}
</style>