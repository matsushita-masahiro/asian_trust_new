<div id="purchases-index">
  <div class="container mt-5 pt-5">
  
    <!-- å¹´æœˆåº¦ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ï¼ˆå›ºå®šï¼‰ -->
    <div class="sticky-top bg-white z-index-sticky month-selector-wrapper">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <%= link_to "ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°ã«æˆ»ã‚‹", user_path(@user, month: @selected_month), 
              class: "btn btn-outline-secondary btn-sm" %>
        </div>
        
        <div>
          <%= form_with url: purchases_user_path(@user), method: :get, local: true do %>
            <%= select_tag :month, options_for_select(@month_options, @selected_month),
                class: "form-select d-inline-block w-auto", onchange: "this.form.submit();" %>
          <% end %>
        </div>
      </div>
    </div>
  
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="bg-light p-3 rounded shadow-sm mb-4">
      <h4 class="mb-2 fw-bold text-dark"><%= @user.name %>ã®è²©å£²å±¥æ­´</h4>
      <div class="text-muted fs-6">
        ğŸ“… ï¼ˆ<%= @selected_month_name %>ï¼‰è²©å£²å®Ÿç¸¾
      </div>
    </div>
  
    <% if @purchases.any? %>
      <div class="table-responsive">
        <table class="table table-bordered table-hover align-middle text-nowrap">
          <thead class="table-secondary text-white">
            <tr>
              <th>è³¼å…¥è€…å</th>
              <th>å•†å“å</th>
              <th class="text-end">å˜ä¾¡ï¼ˆå††ï¼‰</th>
              <th class="text-end">æ•°é‡</th>
              <th class="text-end">åˆè¨ˆï¼ˆå††ï¼‰</th>
              <th class="text-end">ãƒœãƒ¼ãƒŠã‚¹ï¼ˆå††ï¼‰</th>
              <th>ãƒ¡ãƒ¼ãƒ«</th>
              <th>é›»è©±ç•ªå·</th>
              <th>ä½æ‰€</th>
              <th>è³¼å…¥æ—¥æ™‚</th>
            </tr>
          </thead>
          <tbody>
            <% total_sum = 0 %>
            <% total_bonus = 0 %>
  
            <% @purchases.each do |purchase| %>
              <% total = purchase.total_price %>
              <% bonus = @user.bonus_for_purchase(purchase) %>
              <% total_sum += total %>
              <% total_bonus += bonus %>
              <tr>
                <td><%= purchase.customer&.name || "-" %></td>
                <td><%= purchase.product.name %></td>
                <td class="text-end"><%= number_with_delimiter(purchase.unit_price) %></td>
                <td class="text-end"><%= purchase.quantity %></td>
                <td class="text-end text-danger fw-bold"><%= number_with_delimiter(total) %></td>
                <td class="text-end text-success fw-bold"><%= number_with_delimiter(bonus) %></td>
                <td><%= purchase.customer&.email || "-" %></td>
                <td><%= purchase.customer&.phone || "-" %></td>
                <td><%= purchase.customer&.address || "-" %></td>
                <td><%= purchase.purchased_at&.strftime("%Y/%m/%d %H:%M") %></td>
              </tr>
            <% end %>
  
            <!-- åˆè¨ˆè¡Œ -->
            <tr class="table-primary fw-bold text-end">
              <td colspan="5" class="text-end">åˆè¨ˆ</td>
              <td class="text-end text-danger"><%= number_with_delimiter(total_sum) %></td>
              <td class="text-end text-success"><%= number_with_delimiter(total_bonus) %></td>
              <td colspan="4"></td>
            </tr>
          </tbody>
        </table>
      </div>
    <% else %>
      <p class="text-muted">ã“ã®æœˆã®è²©å£²å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    <% end %>
  

  </div>

</div>

<style>
  .z-index-sticky {
    z-index: 1030;
  }
  
  .month-selector-wrapper {
    padding: 1rem 0;
    border-bottom: 1px solid #dee2e6;
    margin-bottom: 1rem;
  }
  
  .table th {
    font-weight: 600;
    font-size: 0.9rem;
  }
  
  .table td {
    font-size: 0.9rem;
  }
  
  .table-hover tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.05);
  }
  
  /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
  @media (max-width: 768px) {
    .d-flex.justify-content-between {
      flex-direction: column;
      align-items: flex-start !important;
    }
    
    .d-flex.justify-content-between > div:first-child {
      margin-bottom: 0.5rem;
    }
    
    .table-responsive {
      font-size: 0.8rem;
    }
    
    .container {
      padding-left: 0.5rem;
      padding-right: 0.5rem;
    }
  }
</style>