<% content_for :title, "紹介機能" %>

<div class="container-fluid" style="margin-top: 80px;">
  <div class="row">
    <div class="col-12">
      <div class="max-w-4xl mx-auto px-4 py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h1 class="h2 text-primary">紹介機能</h1>
          <%= link_to "新しい招待を作成", new_referral_invitation_path, class: "btn btn-primary" %>
        </div>



        <!-- 紹介URL -->
        <div class="card mb-4">
          <div class="card-header">
            <h2 class="card-title mb-0">あなたの紹介URL</h2>
          </div>
          <div class="card-body">
            <div class="input-group mb-3">
              <input 
                type="text" 
                value="<%= @referral_url %>" 
                readonly 
                class="form-control"
                id="referral-url"
              >
              <button 
                onclick="copyToClipboard()" 
                class="btn btn-primary"
                type="button"
              >
                コピー
              </button>
            </div>
            <p class="text-muted small mb-0">
              このURLを新規登録したい方に送信してください。LINEやメールで共有できます。
            </p>
          </div>
        </div>

        <!-- QRコード -->
        <div class="card mb-4">
          <div class="card-header">
            <h2 class="card-title mb-0">QRコード</h2>
          </div>
          <div class="card-body text-center">
            <div class="mb-3">
              <%= link_to qr_code_referral_path(current_user, format: :svg), target: "_blank" do %>
                <img src="<%= qr_code_referral_path(current_user, format: :svg) %>" 
                     alt="紹介QRコード" 
                     class="img-fluid border rounded"
                     style="max-width: 200px; max-height: 200px;">
              <% end %>
            </div>
            <p class="text-muted small">
              QRコードをスクリーンショットして送信するか、<br>
              <%= link_to "こちらから画像をダウンロード", qr_code_referral_path(current_user, format: :svg), 
                          class: "text-primary", target: "_blank" %>
            </p>
          </div>
        </div>

        <!-- 紹介実績 -->
        <div class="card">
          <div class="card-header">
            <h2 class="card-title mb-0">紹介実績</h2>
          </div>
          <div class="card-body">
            <div class="mb-4">
              <span class="h3 text-primary"><%= @total_referrals %></span>
              <span class="text-muted">人を紹介済み</span>
            </div>

            <% if @referred_users.any? %>
              <div class="table-responsive" style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
                <table class="table table-hover" style="min-width: 600px;">
                  <thead class="table-light">
                    <tr>
                      <th style="min-width: 120px;">名前</th>
                      <th style="min-width: 200px;">メールアドレス</th>
                      <th style="min-width: 100px;">レベル</th>
                      <th style="min-width: 120px;">登録日</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% @referred_users.each do |user| %>
                      <tr>
                        <td style="white-space: nowrap;"><%= user.name.presence || "未設定" %></td>
                        <td style="word-break: break-all; min-width: 200px;"><%= user.email %></td>
                        <td style="white-space: nowrap;"><%= user.level&.name || "未設定" %></td>
                        <td style="white-space: nowrap;"><%= user.created_at.strftime("%Y年%m月%d日") %></td>
                      </tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
              
              <!-- スマホ用のスクロールヒント -->
              <div class="d-block d-md-none">
                <small class="text-muted">
                  <i class="fas fa-arrow-left"></i> 左右にスワイプして全ての情報を確認できます
                </small>
              </div>
            <% else %>
              <p class="text-muted">まだ紹介実績がありません。</p>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
/* スマホでのテーブル横スクロール改善 */
@media (max-width: 768px) {
  .table-responsive {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    margin-bottom: 1rem;
  }
  
  .table-responsive::-webkit-scrollbar {
    height: 8px;
  }
  
  .table-responsive::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
  }
  
  .table-responsive::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
  }
  
  .table-responsive::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
  }
  
  /* テーブル内のテキストサイズ調整 */
  .table-responsive .table {
    font-size: 0.875rem;
  }
  
  .table-responsive .table th,
  .table-responsive .table td {
    padding: 0.5rem 0.75rem;
  }
}

/* 横スクロールのヒント表示 */
.table-responsive::after {
  content: "";
  position: absolute;
  top: 0;
  right: 0;
  bottom: 0;
  width: 20px;
  background: linear-gradient(to left, rgba(255,255,255,0.8), transparent);
  pointer-events: none;
}

@media (min-width: 769px) {
  .table-responsive::after {
    display: none;
  }
}
</style>

<script>
function copyToClipboard() {
  const urlInput = document.getElementById('referral-url');
  urlInput.select();
  urlInput.setSelectionRange(0, 99999); // モバイル対応
  
  try {
    document.execCommand('copy');
    alert('URLをコピーしました！');
  } catch (err) {
    console.error('コピーに失敗しました:', err);
    alert('コピーに失敗しました。手動でURLを選択してコピーしてください。');
  }
}
</script>